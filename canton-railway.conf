# Memory-optimized Canton configuration for Railway deployment

canton {
  features {
    enable-testing-commands = yes
  }

  # Memory-optimized monitoring settings
  monitoring {
    health {
      server {
        address = "0.0.0.0"
        port = 7001
      }
    }
  }

  participants {
    participant1 {
      storage {
        type = postgres
        config {
          # Railway automatically provides DATABASE_URL
          url = "${DATABASE_URL}"

          # Reduced connection pool for memory efficiency
          numThreads = 2
          maxConnections = 4
          minConnections = 1
          connectionTimeout = "30s"

          # Memory optimization
          maxLifetime = "600s"
          keepaliveTime = "300s"
        }
      }

      admin-api {
        address = "0.0.0.0"
        port = 5012
      }

      ledger-api {
        address = "0.0.0.0"
        port = 5011
      }

      # Memory optimization parameters
      parameters {
        max-deduplication-duration = "30s"
      }
    }
  }

  domains {
    local {
      storage {
        type = postgres
        config {
          # Use same DATABASE_URL but different schema
          url = "${DATABASE_URL}?currentSchema=domain_local"

          # Minimal connection pool for domain
          numThreads = 1
          maxConnections = 2
          minConnections = 1
          connectionTimeout = "30s"
          maxLifetime = "600s"
        }
      }

      public-api {
        address = "0.0.0.0"
        port = 5018
      }

      admin-api {
        address = "0.0.0.0"
        port = 5019
      }
    }
  }
}

# JSON API Configuration
json-api {
  http-port = ${PORT}
  ledger-host = "localhost"
  ledger-port = 5011
  allow-insecure-tokens = true
  http-address = "0.0.0.0"
}